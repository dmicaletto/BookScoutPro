<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BookScout Market Analyzer</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- HTML5-QRCode Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://images.unsplash.com/photo-1507842217343-583bb7260b66?q=80&w=2670&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            height: 100vh;
            overflow: hidden;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .glass-dark {
            background: rgba(17, 24, 39, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            color: white;
        }

        .scan-line {
            width: 100%;
            height: 2px;
            background: #ef4444;
            position: absolute;
            top: 0;
            left: 0;
            animation: scan 2s infinite linear;
            box-shadow: 0 0 4px #ef4444;
        }

        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Chart Styles */
        .chart-bar {
            transition: height 0.5s ease-out;
            border-top-left-radius: 2px;
            border-top-right-radius: 2px;
        }
        .trend-panel {
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
        }
        .trend-panel.open {
            max-height: 200px; /* Altezza massima per espansione */
            opacity: 1;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="absolute inset-0 bg-black/40 z-0"></div>

    <div class="relative z-10 h-full flex flex-col max-w-md mx-auto bg-white/10 shadow-2xl overflow-hidden sm:border-x sm:border-white/20">
        
        <!-- Header -->
        <header class="glass-dark p-4 flex justify-between items-center shadow-lg shrink-0">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-book-open-reader text-emerald-400 text-xl"></i>
                <h1 class="font-bold text-lg tracking-wide">BookScout Cloud</h1>
            </div>
            <button onclick="toggleMenu()" class="text-white hover:text-emerald-400 transition">
                <i class="fa-solid fa-bars text-xl"></i>
            </button>
        </header>

        <!-- Menu Laterale -->
        <div id="side-menu" class="absolute inset-0 z-50 transform translate-x-full transition-transform duration-300 ease-in-out">
            <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleMenu()"></div>
            <div class="absolute right-0 top-0 bottom-0 w-64 glass-dark shadow-xl flex flex-col p-6">
                <div class="flex justify-between items-center mb-8">
                    <span class="font-bold text-xl text-emerald-400">Menu</span>
                    <button onclick="toggleMenu()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark text-2xl"></i></button>
                </div>
                <nav class="space-y-4 flex-1">
                    <a href="#" onclick="showSection('home'); toggleMenu()" class="flex items-center gap-3 p-3 rounded-lg hover:bg-white/10 transition"><i class="fa-solid fa-barcode w-6 text-center"></i> Scansiona</a>
                    <a href="#" onclick="showSection('inventory'); toggleMenu();" class="flex items-center gap-3 p-3 rounded-lg hover:bg-white/10 transition"><i class="fa-solid fa-boxes-stacked w-6 text-center"></i> Inventario</a>
                    <div class="text-xs text-gray-500 mt-4 px-3">
                        Status: <span id="auth-status" class="text-yellow-500">Connessione...</span>
                    </div>
                </nav>
            </div>
        </div>

        <!-- Main Content Area -->
        <main id="main-content" class="flex-1 overflow-y-auto hide-scroll relative p-4 flex flex-col gap-4">
            
            <!-- SECTION: HOME / SCANNER -->
            <div id="section-home" class="flex flex-col h-full justify-center items-center fade-in">
                
                <div class="glass-panel p-6 rounded-2xl w-full text-center shadow-lg mb-6">
                    <h2 class="text-2xl font-bold mb-2 text-gray-800">Analisi Rapida</h2>
                    <p class="text-gray-600 mb-6 text-sm">Inquadra ISBN. Se il libro è già nell'inventario, vedrai subito i dettagli.</p>

                    <div class="relative bg-gray-900 rounded-xl h-64 w-full mb-4 overflow-hidden flex items-center justify-center group cursor-pointer border-2 border-dashed border-gray-400 hover:border-emerald-500 transition" onclick="startCamera()">
                        <div id="reader" class="w-full h-full absolute inset-0"></div>
                        <div id="camera-placeholder" class="z-10 text-gray-400 flex flex-col items-center">
                            <i class="fa-solid fa-camera text-4xl mb-2 group-hover:text-emerald-400 transition"></i>
                            <span class="text-sm">Tocca per scansionare</span>
                        </div>
                        <div id="scan-overlay" class="hidden absolute inset-0 pointer-events-none z-20">
                            <div class="scan-line"></div>
                            <div class="absolute inset-0 border-2 border-red-500/50 m-8 rounded-lg"></div>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <input type="text" id="isbn-input" placeholder="ISBN Manuale" class="flex-1 p-3 rounded-lg border border-gray-300 focus:outline-none focus:border-emerald-500 text-lg">
                        <button onclick="manualSearch()" class="bg-emerald-600 hover:bg-emerald-700 text-white p-3 rounded-lg transition shadow-md w-14 flex items-center justify-center">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </button>
                    </div>
                </div>

                <button onclick="simulateScan()" class="bg-white/90 hover:bg-white text-emerald-700 font-semibold py-2 px-6 rounded-full shadow-lg text-sm transition transform hover:scale-105">
                    <i class="fa-solid fa-wand-magic-sparkles mr-2"></i> Simula Scansione
                </button>
            </div>

            <!-- SECTION: RESULTS / DETAILS -->
            <div id="section-results" class="hidden flex-col gap-4 pb-20 fade-in">
                <div class="flex justify-between items-center">
                    <button onclick="showSection('home')" class="text-white text-sm flex items-center gap-1 hover:underline">
                        <i class="fa-solid fa-arrow-left"></i> Torna indietro
                    </button>
                    <!-- Indicatore se siamo in modalità modifica -->
                    <span id="mode-badge" class="px-2 py-0.5 rounded text-[10px] font-bold uppercase hidden"></span>
                </div>

                <!-- Product Card -->
                <div class="glass-panel p-4 rounded-xl flex gap-4 items-start shadow-md relative overflow-hidden">
                    <!-- Ribbon se già in inventario -->
                    <div id="inventory-ribbon" class="hidden absolute top-3 right-[-30px] rotate-45 bg-emerald-500 text-white text-[10px] py-1 px-8 font-bold shadow-sm">
                        IN STOCK
                    </div>

                    <img id="book-cover" src="" alt="Book Cover" class="w-24 h-36 object-cover rounded shadow-sm bg-gray-200">
                    <div class="flex-1">
                        <span class="bg-emerald-100 text-emerald-800 text-xs font-bold px-2 py-0.5 rounded-full mb-2 inline-block">ISBN: <span id="res-isbn"></span></span>
                        <h2 id="res-title" class="font-bold text-lg leading-tight mb-1 text-gray-900">Titolo Libro</h2>
                        <p id="res-author" class="text-gray-600 text-sm mb-3">Autore</p>
                        
                        <!-- Dati inventario se presenti -->
                        <div id="inventory-location-badge" class="hidden flex gap-2 mt-2">
                            <div class="bg-gray-800 text-white px-2 py-1 rounded text-xs flex items-center gap-2">
                                <i class="fa-solid fa-location-dot text-emerald-400"></i>
                                <span id="res-shelf-pos">AA-01</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Price Comparison Grid -->
                <h3 class="text-white text-sm font-bold ml-1 mt-2 mb-1">Confronto Prezzi</h3>
                <div class="grid grid-cols-1 gap-3">
                    
                    <!-- Amazon Row -->
                    <div class="bg-white rounded-xl shadow-sm border-l-4 border-yellow-500 overflow-hidden">
                        <div class="p-3 flex items-center justify-between">
                            <div class="flex items-center gap-3 w-1/3">
                                <i class="fa-brands fa-amazon text-xl text-gray-600"></i>
                                <div class="flex flex-col">
                                    <span class="text-xs font-bold text-gray-500">Mercato</span>
                                    <span class="font-bold text-gray-800" id="price-amazon">--</span>
                                </div>
                            </div>
                            <div class="flex-1 border-l border-gray-200 pl-4 flex items-center justify-between">
                                <div class="flex flex-col justify-center">
                                    <span class="text-[10px] text-gray-400 uppercase font-bold mb-1">Il tuo prezzo</span>
                                    <div class="flex items-center gap-2">
                                        <span id="my-price-amazon" class="font-bold text-gray-400 text-sm italic">Non impostato</span>
                                        <span id="diff-amazon"></span>
                                    </div>
                                </div>
                                <button onclick="toggleTrend('amazon')" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-500 transition">
                                    <i class="fa-solid fa-chart-line"></i>
                                </button>
                            </div>
                        </div>
                        <!-- Expanded Trend Chart -->
                        <div id="trend-amazon" class="trend-panel bg-gray-50 px-3 pb-3">
                            <h4 class="text-[10px] font-bold text-gray-400 uppercase mb-2">Andamento ultimi 6 mesi</h4>
                            <div class="h-20 flex items-end justify-between gap-1 text-[8px] text-gray-400" id="chart-amazon">
                                <!-- Bars injected by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- eBay Row -->
                    <div class="bg-white rounded-xl shadow-sm border-l-4 border-blue-500 overflow-hidden">
                        <div class="p-3 flex items-center justify-between">
                            <div class="flex items-center gap-3 w-1/3">
                                <i class="fa-brands fa-ebay text-xl text-gray-600"></i>
                                <div class="flex flex-col">
                                    <span class="text-xs font-bold text-gray-500">Mercato</span>
                                    <span class="font-bold text-gray-800" id="price-ebay">--</span>
                                </div>
                            </div>
                            <div class="flex-1 border-l border-gray-200 pl-4 flex items-center justify-between">
                                <div class="flex flex-col justify-center">
                                    <span class="text-[10px] text-gray-400 uppercase font-bold mb-1">Il tuo prezzo</span>
                                    <div class="flex items-center gap-2">
                                        <span id="my-price-ebay" class="font-bold text-gray-400 text-sm italic">Non impostato</span>
                                        <span id="diff-ebay"></span>
                                    </div>
                                </div>
                                <button onclick="toggleTrend('ebay')" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-500 transition">
                                    <i class="fa-solid fa-chart-line"></i>
                                </button>
                            </div>
                        </div>
                         <!-- Expanded Trend Chart -->
                         <div id="trend-ebay" class="trend-panel bg-gray-50 px-3 pb-3">
                            <h4 class="text-[10px] font-bold text-gray-400 uppercase mb-2">Andamento ultimi 6 mesi</h4>
                            <div class="h-20 flex items-end justify-between gap-1 text-[8px] text-gray-400" id="chart-ebay">
                                <!-- Bars injected by JS -->
                            </div>
                        </div>
                    </div>

                     <!-- AbeBooks Row -->
                     <div class="bg-white rounded-xl shadow-sm border-l-4 border-red-700 overflow-hidden">
                        <div class="p-3 flex items-center justify-between">
                            <div class="flex items-center gap-3 w-1/3">
                                <i class="fa-solid fa-book-open text-xl text-gray-600"></i>
                                <div class="flex flex-col">
                                    <span class="text-xs font-bold text-gray-500">AbeBooks</span>
                                    <span class="font-bold text-gray-800" id="price-abebooks">--</span>
                                </div>
                            </div>
                            <div class="flex-1 border-l border-gray-200 pl-4 flex items-center justify-between">
                                <div class="flex flex-col justify-center">
                                    <span class="text-[10px] text-gray-400 uppercase font-bold mb-1">Il tuo prezzo</span>
                                    <div class="flex items-center gap-2">
                                        <span id="my-price-abebooks" class="font-bold text-gray-400 text-sm italic">Non impostato</span>
                                        <span id="diff-abebooks"></span>
                                    </div>
                                </div>
                                <button onclick="toggleTrend('abebooks')" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-500 transition">
                                    <i class="fa-solid fa-chart-line"></i>
                                </button>
                            </div>
                        </div>
                         <!-- Expanded Trend Chart -->
                         <div id="trend-abebooks" class="trend-panel bg-gray-50 px-3 pb-3">
                            <h4 class="text-[10px] font-bold text-gray-400 uppercase mb-2">Andamento ultimi 6 mesi</h4>
                            <div class="h-20 flex items-end justify-between gap-1 text-[8px] text-gray-400" id="chart-abebooks">
                                <!-- Bars injected by JS -->
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Action Bar -->
                <div class="glass-dark p-4 rounded-xl shadow-lg mt-2 flex flex-col gap-3">
                    <div id="strategy-box">
                         <div class="flex items-center gap-2 mb-2">
                            <i class="fa-solid fa-robot text-emerald-400"></i>
                            <h3 class="font-bold text-white text-xs uppercase">AI Insight</h3>
                        </div>
                        <p class="text-sm text-gray-300 italic" id="res-strategy">Analisi...</p>
                    </div>

                    <button id="main-action-btn" onclick="openInventoryModal()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-lg font-bold transition shadow-lg flex items-center justify-center gap-2">
                        <i class="fa-solid fa-plus"></i> <span>Aggiungi a Inventario</span>
                    </button>
                </div>

            </div>

             <!-- SECTION: INVENTORY LIST -->
             <div id="section-inventory" class="hidden flex-col h-full fade-in">
                <div class="flex justify-between items-end mb-4 px-2">
                    <h2 class="text-2xl font-bold text-white shadow-black drop-shadow-md">Magazzino</h2>
                    <span class="text-xs text-white bg-emerald-600 px-2 py-1 rounded-full" id="inventory-count">0</span>
                </div>

                <div id="inventory-list" class="flex-1 space-y-3 pb-20 overflow-y-auto">
                   <!-- Populated by Firestore -->
                   <div class="text-center text-white mt-10">
                       <i class="fa-solid fa-circle-notch fa-spin"></i> Caricamento...
                   </div>
                </div>
             </div>

        </main>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="hidden absolute inset-0 bg-black/80 z-50 flex-col items-center justify-center text-white backdrop-blur-sm">
            <i class="fa-solid fa-circle-notch fa-spin text-4xl text-emerald-500 mb-4"></i>
            <p class="animate-pulse" id="loading-text">Elaborazione...</p>
        </div>

        <!-- Add/Edit Modal (Reused) -->
        <div id="modal-inventory" class="hidden absolute inset-0 z-50 flex items-end sm:items-center justify-center bg-black/70 backdrop-blur-sm fade-in">
            <div class="bg-white w-full max-w-sm p-6 rounded-t-2xl sm:rounded-2xl shadow-2xl animate-slide-up flex flex-col max-h-[90vh]">
                <div class="flex justify-between items-center mb-4 shrink-0">
                    <h3 class="font-bold text-lg text-gray-800" id="modal-title">Gestione Libro</h3>
                    <button onclick="closeInventoryModal()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                
                <div class="overflow-y-auto hide-scroll flex-1">
                    <p class="text-xs text-gray-500 mb-4 bg-gray-100 p-2 rounded shrink-0">
                        <i class="fa-solid fa-book mr-1"></i> <span id="modal-book-title" class="font-semibold"></span>
                    </p>
    
                    <div class="mb-4">
                        <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Collocazione</h4>
                        <div class="flex gap-4">
                            <div class="flex-1">
                                <input type="text" id="inv-shelf" maxlength="2" class="w-full text-center text-xl font-mono font-bold border-2 border-gray-200 rounded-lg p-2 focus:border-emerald-500 uppercase" placeholder="AA" oninput="this.value = this.value.toUpperCase()">
                                <label class="text-[10px] text-gray-400 block text-center mt-1">Scaffale</label>
                            </div>
                            <div class="flex-1">
                                <input type="number" id="inv-pos" maxlength="2" class="w-full text-center text-xl font-mono font-bold border-2 border-gray-200 rounded-lg p-2 focus:border-emerald-500" placeholder="01">
                                <label class="text-[10px] text-gray-400 block text-center mt-1">Posizione</label>
                            </div>
                        </div>
                    </div>
    
                    <div class="mb-6">
                        <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Tuoi Prezzi (€)</h4>
                        <div class="grid grid-cols-3 gap-2">
                            <div>
                                <label class="text-[10px] text-gray-400 mb-1 block">Amazon</label>
                                <input type="number" step="0.01" id="inv-price-amz" class="w-full p-2 border border-gray-200 rounded-lg text-sm text-center font-bold" placeholder="-">
                            </div>
                            <div>
                                <label class="text-[10px] text-gray-400 mb-1 block">eBay</label>
                                <input type="number" step="0.01" id="inv-price-ebay" class="w-full p-2 border border-gray-200 rounded-lg text-sm text-center font-bold" placeholder="-">
                            </div>
                            <div>
                                <label class="text-[10px] text-gray-400 mb-1 block">Abe</label>
                                <input type="number" step="0.01" id="inv-price-abe" class="w-full p-2 border border-gray-200 rounded-lg text-sm text-center font-bold" placeholder="-">
                            </div>
                        </div>
                    </div>
                </div>

                <button onclick="saveToFirestore()" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-xl hover:bg-emerald-700 transition shadow-lg shrink-0 mt-2">
                    <span id="modal-save-btn">Salva Modifiche</span>
                </button>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- FIREBASE SETUP ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let currentUser = null;
        let inventoryData = []; // Local cache synced with Firestore
        let currentViewedBook = null; // Data of book currently in Detail View
        let isEditingMode = false; // Are we editing an existing item?
        let currentDocId = null; // Firestore Doc ID if editing

        // Auth & Init
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error:", error);
                document.getElementById('auth-status').innerText = "Errore";
                document.getElementById('auth-status').className = "text-red-500";
            }
        };

        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-status').innerText = "Online";
                document.getElementById('auth-status').className = "text-emerald-500";
                
                // Start listening to Firestore
                const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'inventory'));
                onSnapshot(q, (snapshot) => {
                    inventoryData = snapshot.docs.map(doc => ({
                        firestoreId: doc.id,
                        ...doc.data()
                    }));
                    renderInventoryList(); // Re-render list if open
                }, (error) => {
                    console.error("Firestore Error:", error);
                });
            }
        });

        // --- MOCK DATA FOR MARKET ANALYSIS ---
        const mockDb = {
            "default": {
                title: "Il Nome della Rosa",
                author: "Umberto Eco",
                cover: "https://m.media-amazon.com/images/I/71hVw-q+F7L._AC_UF1000,1000_QL80_.jpg",
                amazon: 12.50,
                ebay: 9.90,
                abebooks: 18.00,
                strategy: "Opportunità di arbitraggio su eBay.",
                margin: "+65%"
            }
        };

        // --- CORE LOGIC ---

        // Espongo le funzioni necessarie all'HTML
        window.manualSearch = () => {
            const isbn = document.getElementById('isbn-input').value;
            if(isbn.length > 3) processIsbn(isbn);
            else alert("ISBN troppo corto");
        };

        window.simulateScan = () => {
            const r = Math.floor(Math.random() * 1000);
            processIsbn("978-DEMO-" + r);
        };

        window.processIsbn = async (isbn) => {
            showLoader(true);

            // 1. Check if in Inventory (Sync check is fine thanks to onSnapshot)
            const existingItem = inventoryData.find(item => item.book.isbn === isbn);

            if (existingItem) {
                // BOOK ALREADY EXISTS -> Open Detail in "Inventory Mode"
                showLoader(false);
                openDetailView(existingItem, true);
            } else {
                // NEW SCAN -> Fetch Market Data (Simulated) & Open Detail in "New Mode"
                setTimeout(() => {
                    // Create a "book object" simulating API response
                    const mockData = mockDb['default'];
                    const newBook = {
                        isbn: isbn,
                        title: mockData.title,
                        author: mockData.author,
                        cover: mockData.cover,
                        prices: { // Randomize slightly for realism
                            amazon: (mockData.amazon + (Math.random() * 4 - 2)).toFixed(2),
                            ebay: (mockData.ebay + (Math.random() * 4 - 2)).toFixed(2),
                            abebooks: (mockData.abebooks + (Math.random() * 4 - 2)).toFixed(2)
                        },
                        // Generate mock history for charts [6 months]
                        history: {
                            amazon: Array.from({length: 6}, () => (mockData.amazon + (Math.random() * 5 - 2)).toFixed(2)),
                            ebay: Array.from({length: 6}, () => (mockData.ebay + (Math.random() * 5 - 2)).toFixed(2)),
                            abebooks: Array.from({length: 6}, () => (mockData.abebooks + (Math.random() * 5 - 2)).toFixed(2))
                        },
                        strategy: mockData.strategy
                    };
                    
                    showLoader(false);
                    openDetailView({ book: newBook }, false); // False = not in inventory
                }, 800);
            }
        };

        // --- CHART LOGIC ---
        window.toggleTrend = (channel) => {
            const panel = document.getElementById(`trend-${channel}`);
            const isOpen = panel.classList.contains('open');
            
            // Close all others first (optional UX choice)
            document.querySelectorAll('.trend-panel').forEach(p => p.classList.remove('open'));

            if (!isOpen) {
                renderChart(channel);
                panel.classList.add('open');
            }
        };

        function renderChart(channel) {
            const container = document.getElementById(`chart-${channel}`);
            // Get history from current book object
            // If book was loaded from inventory or new scan, it should have history. 
            // If old inventory items don't have history, we mock it on the fly.
            
            let history = currentViewedBook.book.history?.[channel];
            
            // Fallback for old items without history
            if (!history) {
                 const currentPrice = parseFloat(currentViewedBook.book.prices[channel]);
                 history = Array.from({length: 6}, () => (currentPrice + (Math.random() * 4 - 2)).toFixed(2));
            }

            const maxVal = Math.max(...history.map(parseFloat)) * 1.1;
            const minVal = Math.min(...history.map(parseFloat)) * 0.9;
            const months = ["Lug", "Ago", "Set", "Ott", "Nov", "Dic"];

            const barsHtml = history.map((val, i) => {
                const heightPct = ((val - minVal) / (maxVal - minVal)) * 80 + 10; // Normalize to 10-90% height
                // Determine color (green if trending up vs prev, red if down)
                const prev = i > 0 ? history[i-1] : val;
                const colorClass = val >= prev ? 'bg-emerald-400' : 'bg-red-400';
                
                return `
                    <div class="flex flex-col items-center justify-end h-full w-full group">
                         <span class="mb-1 opacity-0 group-hover:opacity-100 transition text-[9px] font-bold text-gray-600">€${val}</span>
                        <div class="w-3 ${colorClass} chart-bar rounded-t" style="height: ${heightPct}%"></div>
                        <span class="mt-1">${months[i]}</span>
                    </div>
                `;
            }).join('');

            container.innerHTML = barsHtml;
        }


        // --- UI FUNCTIONS ---

        function openDetailView(item, isInventoryItem) {
            currentViewedBook = item; // Store for Modal
            isEditingMode = isInventoryItem;
            currentDocId = item.firestoreId || null;

            // Close charts if open
            document.querySelectorAll('.trend-panel').forEach(p => p.classList.remove('open'));

            // UI Elements
            const els = {
                isbn: document.getElementById('res-isbn'),
                title: document.getElementById('res-title'),
                author: document.getElementById('res-author'),
                cover: document.getElementById('book-cover'),
                ribbon: document.getElementById('inventory-ribbon'),
                locBadge: document.getElementById('inventory-location-badge'),
                locText: document.getElementById('res-shelf-pos'),
                btn: document.getElementById('main-action-btn'),
                badge: document.getElementById('mode-badge')
            };

            // Common Data
            els.isbn.innerText = item.book.isbn;
            els.title.innerText = item.book.title;
            els.author.innerText = item.book.author;
            els.cover.src = item.book.cover;

            // Market Prices
            document.getElementById('price-amazon').innerText = `€ ${item.book.prices.amazon}`;
            document.getElementById('price-ebay').innerText = `€ ${item.book.prices.ebay}`;
            document.getElementById('price-abebooks').innerText = `€ ${item.book.prices.abebooks}`;
            document.getElementById('res-strategy').innerText = item.book.strategy || "Nessun consiglio disponibile";

            // CONTEXT SWITCHING
            if (isInventoryItem) {
                // MODE: INVENTORY
                els.ribbon.classList.remove('hidden');
                els.locBadge.classList.remove('hidden');
                els.locText.innerText = `${item.location.shelf}-${item.location.position}`;
                
                els.btn.innerHTML = `<i class="fa-solid fa-pen-to-square"></i> <span>Modifica Dati & Prezzi</span>`;
                els.btn.className = "w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg font-bold transition shadow-lg flex items-center justify-center gap-2";
                
                els.badge.innerText = "IN MAGAZZINO";
                els.badge.className = "px-2 py-0.5 rounded text-[10px] font-bold uppercase bg-blue-100 text-blue-800";
                els.badge.classList.remove('hidden');

                // Render Comparisons
                renderPriceComparison('amazon', item.book.prices.amazon, item.myPrices?.amazon);
                renderPriceComparison('ebay', item.book.prices.ebay, item.myPrices?.ebay);
                renderPriceComparison('abebooks', item.book.prices.abebooks, item.myPrices?.abebooks);

            } else {
                // MODE: NEW SCAN
                els.ribbon.classList.add('hidden');
                els.locBadge.classList.add('hidden');
                
                els.btn.innerHTML = `<i class="fa-solid fa-plus"></i> <span>Aggiungi a Inventario</span>`;
                els.btn.className = "w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-lg font-bold transition shadow-lg flex items-center justify-center gap-2";
                
                els.badge.classList.add('hidden');

                // Reset comparisons
                resetPriceComparison('amazon');
                resetPriceComparison('ebay');
                resetPriceComparison('abebooks');
            }

            window.showSection('results');
        }

        function renderPriceComparison(channel, marketPrice, myPrice) {
            const myEl = document.getElementById(`my-price-${channel}`);
            const diffEl = document.getElementById(`diff-${channel}`);

            if (!myPrice || myPrice == 0) {
                myEl.innerText = "Non impostato";
                myEl.className = "text-gray-400 text-xs italic";
                diffEl.innerHTML = "";
                return;
            }

            const market = parseFloat(marketPrice);
            const my = parseFloat(myPrice);
            const diff = my - market;

            myEl.innerText = `€ ${my.toFixed(2)}`;
            
            if (diff > 0) {
                // I'm more expensive (Bad?)
                myEl.className = "text-red-500 font-bold";
                diffEl.innerHTML = `<span class="text-[10px] bg-red-100 text-red-600 px-1 rounded">+€${diff.toFixed(2)}</span>`;
            } else {
                // I'm cheaper (Good?)
                myEl.className = "text-emerald-600 font-bold";
                diffEl.innerHTML = `<span class="text-[10px] bg-emerald-100 text-emerald-600 px-1 rounded">COMPETITIVO</span>`;
            }
        }

        function resetPriceComparison(channel) {
            document.getElementById(`my-price-${channel}`).innerText = "---";
            document.getElementById(`my-price-${channel}`).className = "text-gray-300";
            document.getElementById(`diff-${channel}`).innerHTML = "";
        }

        // --- FIRESTORE OPERATIONS ---

        window.openInventoryModal = () => {
            if(!currentViewedBook) return;
            
            const item = currentViewedBook;
            document.getElementById('modal-book-title').innerText = item.book.title;

            // Pre-fill if editing, clear if new
            if (isEditingMode) {
                document.getElementById('modal-title').innerText = "Modifica Libro";
                document.getElementById('modal-save-btn').innerText = "Salva Modifiche";
                document.getElementById('inv-shelf').value = item.location.shelf;
                document.getElementById('inv-pos').value = item.location.position;
                document.getElementById('inv-price-amz').value = item.myPrices?.amazon || "";
                document.getElementById('inv-price-ebay').value = item.myPrices?.ebay || "";
                document.getElementById('inv-price-abe').value = item.myPrices?.abebooks || "";
            } else {
                document.getElementById('modal-title').innerText = "Nuovo Inserimento";
                document.getElementById('modal-save-btn').innerText = "Aggiungi a Magazzino";
                document.getElementById('inv-shelf').value = "";
                document.getElementById('inv-pos').value = "";
                document.getElementById('inv-price-amz').value = "";
                document.getElementById('inv-price-ebay').value = "";
                document.getElementById('inv-price-abe').value = "";
            }

            document.getElementById('modal-inventory').classList.remove('hidden');
        };

        window.saveToFirestore = async () => {
            if (!currentUser) return alert("Devi attendere l'autenticazione.");

            const shelf = document.getElementById('inv-shelf').value.toUpperCase();
            let pos = document.getElementById('inv-pos').value;
            
            if (shelf.length < 1 || !pos) return alert("Dati posizione mancanti");
            pos = pos.toString().padStart(2, '0');

            const myPrices = {
                amazon: document.getElementById('inv-price-amz').value,
                ebay: document.getElementById('inv-price-ebay').value,
                abebooks: document.getElementById('inv-price-abe').value
            };

            const inventoryCollection = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'inventory');

            showLoader(true, "Salvataggio...");
            
            try {
                if (isEditingMode && currentDocId) {
                    // UPDATE
                    await updateDoc(doc(inventoryCollection, currentDocId), {
                        location: { shelf, position: pos },
                        myPrices: myPrices
                    });
                    alert("Aggiornato!");
                } else {
                    // CREATE
                    await addDoc(inventoryCollection, {
                        book: currentViewedBook.book, // Ensure we pass the clean book object
                        location: { shelf, position: pos },
                        myPrices: myPrices,
                        dateAdded: new Date().toISOString()
                    });
                    alert("Salvato in Cloud!");
                }
                
                window.closeInventoryModal();
                // After save, we usually assume it's now an inventory item.
                // Re-process the ISBN to switch the view mode to "Inventory"
                window.processIsbn(currentViewedBook.book.isbn);

            } catch (e) {
                console.error(e);
                alert("Errore salvataggio: " + e.message);
                showLoader(false);
            }
        };

        window.deleteItem = async (e, id) => {
            e.stopPropagation(); // Prevent opening detail when clicking trash
            if(!confirm("Eliminare definitivamente?")) return;
            
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'inventory', id));
            } catch(err) {
                alert("Errore eliminazione");
            }
        };

        // --- RENDER LIST ---
        function renderInventoryList() {
            const container = document.getElementById('inventory-list');
            document.getElementById('inventory-count').innerText = inventoryData.length;

            if (inventoryData.length === 0) {
                container.innerHTML = `<div class="glass-panel p-6 text-center text-gray-500 rounded-xl m-4">Inventario Vuoto</div>`;
                return;
            }

            container.innerHTML = inventoryData.map(item => `
                <div onclick="processIsbn('${item.book.isbn}')" class="glass-panel p-3 rounded-xl flex gap-3 items-center shadow-sm mx-1 cursor-pointer hover:bg-white/40 transition">
                    <div class="bg-gray-800 text-white w-12 h-12 rounded-lg flex flex-col items-center justify-center shrink-0 border border-emerald-500/50">
                        <span class="text-[10px] font-bold text-emerald-400">${item.location.shelf}</span>
                        <span class="text-md font-bold leading-none">${item.location.position}</span>
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <h4 class="font-bold text-gray-900 truncate text-sm">${item.book.title}</h4>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-[10px] bg-gray-200 text-gray-600 px-1.5 rounded">Mkt: €${item.book.prices.amazon}</span>
                            ${item.myPrices?.amazon ? `<span class="text-[10px] bg-blue-100 text-blue-700 px-1.5 rounded font-bold">Tu: €${item.myPrices.amazon}</span>` : ''}
                        </div>
                    </div>
                    <button onclick="deleteItem(event, '${item.firestoreId}')" class="w-8 h-8 rounded-full bg-red-100 text-red-500 hover:bg-red-200 flex items-center justify-center transition shrink-0 ml-1">
                        <i class="fa-solid fa-trash-can text-sm"></i>
                    </button>
                </div>
            `).join('');
        }

        // --- GLOBAL HELPERS (attached to window for HTML access) ---
        window.showSection = (id) => {
            document.getElementById('section-home').classList.add('hidden');
            document.getElementById('section-results').classList.add('hidden');
            document.getElementById('section-inventory').classList.add('hidden');
            document.getElementById('section-' + id).classList.remove('hidden');
            if(id === 'inventory') renderInventoryList();
        };

        window.toggleMenu = () => {
            const m = document.getElementById('side-menu');
            m.classList.toggle('translate-x-full');
        };

        window.closeInventoryModal = () => document.getElementById('modal-inventory').classList.add('hidden');
        
        function showLoader(show, text = "Elaborazione...") {
            const el = document.getElementById('loading-overlay');
            if(show) {
                document.getElementById('loading-text').innerText = text;
                el.classList.remove('hidden');
                el.style.display = 'flex';
            } else {
                el.classList.add('hidden');
                el.style.display = 'none';
            }
        }
        
        // --- CAMERA ---
        let html5QrCode;
        window.startCamera = () => {
             document.getElementById('camera-placeholder').classList.add('hidden');
             document.getElementById('scan-overlay').classList.remove('hidden');
             html5QrCode = new Html5Qrcode("reader");
             html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 150 } }, 
                (decodedText) => {
                    html5QrCode.stop().then(() => {
                         document.getElementById('camera-placeholder').classList.remove('hidden');
                         document.getElementById('scan-overlay').classList.add('hidden');
                         html5QrCode.clear();
                         window.processIsbn(decodedText);
                    });
                }
             ).catch(err => {
                 alert("Errore camera. Usa HTTPS.");
                 document.getElementById('camera-placeholder').classList.remove('hidden');
                 document.getElementById('scan-overlay').classList.add('hidden');
             });
        };

    </script>
</body>
</html>
